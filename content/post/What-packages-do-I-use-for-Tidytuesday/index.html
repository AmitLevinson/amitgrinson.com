---
title: Github actions with Tidytuesday packages
author: Amit Levinson
date: '2020-07-09'
slug: Identifying-packages-used-for-Tidytuesday
categories: [R]
tags: [TidyTuesday, GitHub]
subtitle: ''
summary: 'Trying out GitHub actions by automating a rendering of a plot of what packages I use and how many'
authors: []
featured: yes
image:
  caption: 'Image by Pixabay'
  focal_point: ''
  preview_only: yes
projects: []
editor_options: 
  chunk_output_type: console
draft: true
---

<link href="index_files/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="index_files/anchor-sections/anchor-sections.js"></script>


<p>Thank you very much to XXX for the help!</p>
<div id="introduction-and-why" class="section level2">
<h2>Introduction and why</h2>
<p>I love automation. I mean, who doesn‚Äôt‚ÄìYou set everything up and either click away once in a while or have something automatically produced. I‚Äôve decided to try and give GitHub actions a try by automating something. Similar to previous blog posts where I find an example to learn something, this post will focus making a continuously updating plot on every push. The plot will contain the packages I use for #TidyTuesday and their frequency.</p>
<p>In short, #Tidytuesday is an awesome weekly data project enabling you to analyze and visualize new data every week. You can find more info on the project‚Äôs Github page, or read more how it helped me in my journey of learning R. Unfortunately, I haven‚Äôt been participating that often lately due to thesis writing, but everyone is welcome anytime.</p>
<p>The project provides a perfect opportunity for me to try a GitHub action, since every week I open a new R code for that particular dataset. This results in multiple R files containing the analysis, and more relevant to us, the packages we used. What I hope to do in this blog post is to walk you through on how to extract the packages I‚Äôve used in all my TidyTuesday participation, and finally the setup I did for the Github action. I will not, however, elaborate too much on the GitHub action as I myself am a complete novice when it comes to setting up.</p>
</div>
<div id="quick-base-r-from-michael-dorman" class="section level2">
<h2>Quick base R (From Michael Dorman)</h2>
<p>Before I begin, a shout out to <a href="https://geobgu.xyz/">Michael Dorman</a>. A while back he posted in the Israeli R group his code for extracting the packages he uses and created a plot out of it. Essentially, that‚Äôs the answer and insipiration for this post. I did however want to challenge myself in addition to the Github Action so I‚Äôll provide his code below and will walk through my tidyversian approach. Here‚Äôs Michael‚Äôs original code in Base R:</p>
<p>XXXX</p>
</div>
<div id="tidyversian-approach" class="section level2">
<h2>Tidyversian approach</h2>
<p>Michael‚Äôs code is fantastic, but what‚Äôs a blog post without some challenges and tears.</p>
<div id="reading-files" class="section level3">
<h3>Reading files</h3>
<p>First and most important, I recommend using the <a href="https://github.com/jennybc/here_here">{here}</a> package by <a href="https://jennybryan.org/">Jennifer Bryan</a>. The only reason I‚Äôm using a direct path is because my R project and here assumes I‚Äôm within my website directory, making it a challenge to move between project roots. The argument basically lists all the file within the path we wrote ending in <code>.R</code> or <code>.Rmd</code>. The <code>recursive = TRUE</code> runs the same code through all subfolders. Lastly, the reason I filter the last element of the vector is because that‚Äôs the code file I use to produce the plot.</p>
<pre><code>## [1] &quot;2019/1_Week38_Number of Visitors/National Parks.R&quot;       
## [2] &quot;2019/2_Week39_SchoolDiversity/School_Diversity.R&quot;        
## [3] &quot;2019/2_Week39_SchoolDiversity/School_Diversity_Updated.R&quot;
## [4] &quot;2019/Week40_All the Pizza/Barstool_Top_2_Percent.R&quot;      
## [5] &quot;2019/Week40_All the Pizza/BarstoolPizza.R&quot;               
## [6] &quot;2019/Week41_Power_lifting/ipf.R&quot;</code></pre>
<p>We see the R scripts I used to produce my Tidytuesdays. Unfortunately, it also returns R scripts I opened but didn‚Äôt completely follow through wtih the analysis. That is, sometimes I worked on a TidyTuesday but stopped and left it incomplete so it‚Äôll return that too. It‚Äôs not that many and I imagine you can workaround it if you want.</p>
<p>Before we dig in I want to get the name of the scripts. This is mandatory for the analysis, but I found in nicer to look at the packages used corresponding to the Tidytuesday. Of course getting the names can provide an opportunity for further analysis by Tidytuesday if you wish to do so:</p>
<pre><code>## [1] &quot;National Parks&quot;           &quot;School_Diversity&quot;        
## [3] &quot;School_Diversity_Updated&quot; &quot;Barstool_Top_2_Percent&quot;  
## [5] &quot;BarstoolPizza&quot;            &quot;ipf&quot;</code></pre>
<p>Let‚Äôs see what we did here, and to better understand the regex let‚Äôs see how our original string looked like: 2019/1_Week38_Number of Visitors/National Parks.R. Basically, we want to take everything after the last <code>/</code> (‚ÄúNational Parks.R‚Äù) using <code>[^/]+</code>, and then remove everything from the final period to the end with a positive look ahead <code>(?=\\.)</code>. Voilla, our final output of ‚ÄúNational Parks‚Äù.</p>
<p>Finally we can read in the text from all these R scripts:</p>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2019/1_Week38_Number of Visitors/National Parks.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2019/2_Week39_SchoolDiversity/School_Diversity.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2019/2_Week39_SchoolDiversity/School_Diversity_Updated.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2019/Week43_Horror_Films/horror_films.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2019/Week44_NYC_Squerrils/draft_squerrils.Rmd&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2019/Week45_bike_walk/bike_walk.Rmd&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week12_theoffice/the_office.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week17_gdpr/gdpr.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week18_broadway/broadway.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week23_marble-races/marble-races.Rmd&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week25-slavery/week25-slavery.Rmd&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week31_penguins/week31_penguins.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week4_spotify_songs/spotify_songs.R&#39;</code></pre>
<pre><code>## Warning in .f(.x[[i]], ...): incomplete final line found on &#39;C:/Users/amitl/
## R_code/tidytuesday\/2020/week51_ninja/ninja_warriors.R&#39;</code></pre>
<pre><code>## [1] &quot;library(tidyverse)&quot;                                                                                                                              
## [2] &quot;library(png)&quot;                                                                                                                                    
## [3] &quot;library(gridGraphics)&quot;                                                                                                                           
## [4] &quot;&quot;                                                                                                                                                
## [5] &quot;park_visits &lt;- readr::read_csv(\&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-17/national_parks.csv\&quot;)&quot;
## [6] &quot;&quot;</code></pre>
<p>I‚Äôm definitely not your go-to when it comes to iteration such as <code>purrr::map</code>, but let me try and simplify what we just did. I first created the complete path of our scripts and then iterated the function <code>readLines</code> across it. I could have done the pasting within <code>map</code> but I wanted to simplify it for us. Essentially, you can read <code>map</code> as follows: Run function <code>readLines</code> on every element of vector <code>tt_path</code> (The vector containing our path to each R/Rmd script). For a better understanding of the <code>map</code> function I highly recommend exploring the <a href="https://purrr.tidyverse.org/reference/map.html">documentations</a>.</p>
<p>I then printed the head script so that we can look at it as we continue our extraction of packages. First off, notice I subset it using <code>[[1]]</code>, that‚Äôs because <code>map</code> returned a list class. Second, and more important for our analysis, our line breaks from the original code are preserved. That means that every element of a package script (a list within a list) is essentially a line. Therefore, we can operate on it without any special regex other than searching for the <code>library</code> function.</p>
<p>However, a caveat is important to state: I do not attempt to capture packages called inline such as the <code>readr::read_csv</code>. It‚Äôs definitely possible, but I decided not to for this example. I imagine you can easily incorporate it in some manner if you wish to do so.</p>
</div>
<div id="cleaning" class="section level3">
<h3>Cleaning</h3>
<p>Ok then, now that we read all lines in let‚Äôs extract all libraries. If my memory is correct, I mainly use functions either by loadings the library through <code>library()</code> or inline with <code>library::</code> so let‚Äôs capture that and return a dataframe:</p>
<pre><code>## # A tibble: 254 x 2
##    tidytuesday              package             
##    &lt;chr&gt;                    &lt;chr&gt;               
##  1 National Parks           tidyverse           
##  2 National Parks           png                 
##  3 National Parks           gridGraphics        
##  4 National Parks           park_visits &lt;- readr
##  5 School_Diversity         tidyverse           
##  6 School_Diversity         stringr             
##  7 School_Diversity_Updated tidyverse           
##  8 School_Diversity_Updated stringr             
##  9 School_Diversity_Updated forcats             
## 10 Barstool_Top_2_Percent   tidyverse           
## # ... with 244 more rows</code></pre>
<p>Perfect! First I added the original script names as the id for each sub list within the <code>file_lines</code>. We then want to capture any library we use across all sub-lists and return it nicely in a data frame. Let‚Äôs tackle each element at a time starting with the regular expression.</p>
<p>We can split the regex into two parts. the first one <code>(?&lt;=library\\()).+(?=\\())</code> can be read as follows: Look for everything that comes after <code>library(</code> and before <code>)</code>. the <code>(?&lt;=</code> is a positive look behind, basically capture everything that comes after <code>library\\(</code>. We use the two slashes to escape <code>(</code> and tell R we‚Äôre specifically looking for a parenthesis. A positive look ahead and look behind should be enclosed within <code>()</code>. We want to save everything after the <code>library(</code>, and that‚Äôs what <code>.+</code> does‚Äì Capture at least one symbol and more after the look behind we wrote. The <code>(?=\\))</code> is a positive look ahead and tells our regex to expect it and read until there but exclude it.</p>
<p>The second section of the regex <code>[a-z].+(?=::))</code> essentially mimics the previous one but only with a positive look ahead. Capture everything before the two <code>::</code>. FINISH ADDING THE REGEX.</p>
<p>What we did in this argument was iterate the <code>str_extract</code> argument across each sublist of our <code>file_lines</code> object, the object that contained all our R scripts. To do this we used <code>map_dfr</code> which works similarly to <code>map</code> only returns a <code>data.frame</code> and not a list. Here I specifically returned a <code>tibble</code>, but either one works. Since it returns a data frame we can provide a column name, here it‚Äôs assigned as <code>package</code>. In addition, <code>map_df*</code> (map_df, map_dfr, etc.) can take an <code>.id</code> argument the will return the names of the original sub-lists as a column. Lastly all lines that didn‚Äôt match our regex - empty lines, arguments, comments, etc. - returned <code>NA</code> (actually that‚Äôs the majority of lines) so we filtered them.</p>
</div>
<div id="plot" class="section level3">
<h3>plot</h3>
<p>We‚Äôre at the last part of reading-processing-plotting journey. The plot is pretty straight forward and I invite you to explore other plots. However, remember that we‚Äôre gonna want it to be automated so make sure you don‚Äôt create something you‚Äôll have to return to it. For example, if you wish to add each time a new name for that week you‚Äôll have to provide room for it in future rendering.</p>
<div class="figure"><span id="fig:unnamed-chunk-7"></span>
<img src="index_files/figure-html/unnamed-chunk-7-1.png" alt="the plot we want to be rendered everytime we push to our Tidytuesday repository" width="672" />
<p class="caption">
Figure 1: the plot we want to be rendered everytime we push to our Tidytuesday repository
</p>
</div>
<p>Above we created the plot we‚Äôre gonna want to be rendered every time we push. A few things to note:</p>
<ol style="list-style-type: decimal">
<li><p>I created a simple bar chart but feel free to explore other plots. Also, if you don‚Äôt intend of having it rendered every time you push to GitHub then go crazy with other plots. I wanted to keep it simple but I‚Äôm sure you can explore other plots.</p></li>
<li><p>I decided to only take the top 15 frequently used packages. You can play around with it to find a number you like or one that properly fits.</p></li>
<li><p>Notice that I added to the caption the date it was rendered. This will update every time our plot updates, i.e.¬†every time we push to our #TidyTuesday repository.</p></li>
</ol>
<p>Looking at the plot I notice I load various packages twice üòÖ, mostly if I load the <code>{tidyverse}</code> and then again in specifically such as <code>stringr</code> or <code>lubridate</code>. At least now I‚Äôll remember this for future work!</p>
</div>
</div>
<div id="github-action" class="section level2">
<h2>GitHub action</h2>
<p>Well this was my first time around using GitHub action. Unfortunately, I don‚Äôt know much about GitHub actions so I‚Äôll first suggest a few resources I found useful:</p>
<ol style="list-style-type: decimal">
<li><p>Jim Hester‚Äôs <a href="https://www.jimhester.com/talk/2020-rsc-github-actions/">rstudio talk</a> on GitHub actions - Great resource for an introduction and to get you excited about the opportunities with GitHub action.</p></li>
<li><p>Gavin Simpson‚Äôs blog post <a href="https://fromthebottomoftheheap.net/2020/04/30/rendering-your-readme-with-github-actions/">‚ÄòRendering your README with GitHub Actions‚Äô</a> - A more hands-on approach on setting everything up. I mainly followed along his blog post which I highly recommend you do too.</p></li>
</ol>
<p>Seriously, I highly recommend following Gavin Simpson‚Äôs approach. In any event, here are the steps I did:</p>
<ol style="list-style-type: decimal">
<li><p>If you don‚Äôt have the <code>{usethis}</code> package, make sure to install it with <code>install.packages("usethis")</code>. The package makes it extremely easy to work with GitHub Actions with providing great templates and setups.</p></li>
<li><p>Next we‚Äôre going to create a <code>.yaml</code> file that will contain all our commands. the <code>usethise</code> package provides many templates for bookdowns, blogdowns, packages, etc. I found the <code>README.Rmd</code> template suitable to learn from so we‚Äôll create that. Just type the following in the r console in the root folder of your repository:</p></li>
</ol>
<pre><code>usethis::use_github_action()</code></pre>
<p>And you should get the following output, only with your folders instead:</p>
<pre><code>‚àö Setting active project to &#39;C:/Users/amitl/R_code/TidyTuesday&#39;
‚àö Creating &#39;.github/&#39;
‚àö Adding &#39;^\\.github$&#39; to &#39;.Rbuildignore&#39;
‚àö Adding &#39;*.html&#39; to &#39;.github/.gitignore&#39;
‚àö Creating &#39;.github/workflows/&#39;
‚àö Writing &#39;.github/workflows/R-CMD-check.yaml&#39;
* Copy and paste the following lines into &#39;C:/Users/amitl/R_code/TidyTuesday/README.md&#39;:
  &lt;!-- badges: start --&gt;
  [![R build status](https://github.com/AmitLevinson/TidyTuesday/workflows/R-CMD-check/badge.svg)](https://github.com/AmitLevinson/TidyTuesday/actions)
  &lt;!-- badges: end --&gt;</code></pre>
<p>Perfect. We‚Äôre not going to copy the lines suggested as they‚Äôre helpful for package checks, and we‚Äôre only interested in producing a plot.</p>
<pre><code>&gt; usethis::use_github_actions()
‚àö Setting active project to &#39;C:/Users/amitl/R_code/TidyTuesday&#39;
‚àö Creating &#39;.github/&#39;
‚àö Adding &#39;^\\.github$&#39; to &#39;.Rbuildignore&#39;
‚àö Adding &#39;*.html&#39; to &#39;.github/.gitignore&#39;
‚àö Creating &#39;.github/workflows/&#39;
‚àö Writing &#39;.github/workflows/R-CMD-check.yaml&#39;
* Copy and paste the following lines into &#39;C:/Users/amitl/R_code/TidyTuesday/README.md&#39;:
  &lt;!-- badges: start --&gt;
  [![R build status](https://github.com/AmitLevinson/TidyTuesday/workflows/R-CMD-check/badge.svg)](https://github.com/AmitLevinson/TidyTuesday/actions)
  &lt;!-- badges: end --&gt;</code></pre>
</div>
